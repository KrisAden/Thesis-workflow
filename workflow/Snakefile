# workflow/Snakefile
import os, sys
from pathlib import Path
from snakemake.shell import shell

ROOT = Path.cwd()
SRC  = ROOT / "src"
PYTHON = sys.executable
CFG = ROOT / "config/config.yaml"

# OS-aware runner; pass module name per rule
if os.name == "nt":
    shell.executable("powershell")
    RUN = lambda module: f'& "{PYTHON}" -m {module} --config "{CFG}"'
else:
    shell.executable("/bin/bash")
    RUN = lambda module: f'PYTHONPATH="{SRC}" "{PYTHON}" -m {module} --config "{CFG}"'

rule all:
    input:
        "data/interim/network_expansion.nc",
        "data/interim/network_storage.nc",
        "data/interim/network_costed.nc",
        "results/tables/load_scaling.csv",
        "results/tables/tx_expansion_bounds.csv",
        "results/tables/storage_costs_applied.csv",
        "results/tables/generator_capital_costs.csv",

rule rescale_loads:
    output:
        "data/interim/network_rescaled.nc",
        "results/tables/load_scaling.csv"
    shell:
        RUN("pypsa_thesis.preprocess")

rule enable_expansion:
    input:
        "data/interim/network_rescaled.nc"
    output:
        "data/interim/network_expansion.nc",
        "results/tables/tx_expansion_bounds.csv"
    shell:
        # 1) build the expansion network (as before)
        # 2) immediately apply renewable bounds IN-PLACE, controlled by config flag
        RUN("pypsa_thesis.build_network") + " && " +
        RUN("pypsa_thesis.apply_renewable_bounds --network-in {output[0]} --network-out {output[0]}")


rule add_storage:
    input:
        "data/interim/network_expansion.nc",
        "data/raw/storage_costs.csv"
    output:
        "data/interim/network_storage.nc",
        "results/tables/storage_costs_applied.csv"
    shell:
        RUN("pypsa_thesis.apply_storage")

rule apply_costs:
    input:
        "data/interim/network_expansion.nc",
        "data/raw/generator_costs.csv"          # <- add the CSV as an input dependency
    output:
        "data/interim/network_costed.nc",
        "results/tables/generator_capital_costs.csv"
    shell:
        RUN("pypsa_thesis.apply_costs")
